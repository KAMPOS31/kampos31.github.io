<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Producto</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <h1 id="title">Consulta de Producto</h1>
    <button id="startButton"><i class="fas fa-qrcode"></i> Escanear QR</button>
    <div id="reader"><p>Coloca el código QR frente a la cámara</p></div>
    <p id="loading" style="display: none;">Cargando...</p>
    <label for="fileInput" class="custom-file-upload"><i class="fas fa-file-upload"></i> CARGAR EXCEL</label>
    <input type="file" id="fileInput" style="display: none;" />
    <div id="infoTitle" style="display: none;"><i class="fas fa-info-circle"></i> Información del Producto</div>
    <div id="tarjetaProductos" class="card" style="display: none;"></div>
    <button id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i> Regresar</button>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let folio = localStorage.getItem("folio") ? parseInt(localStorage.getItem("folio")) : 1;
            const html5QrCode = new Html5Qrcode("reader");
            let excelData = [];
            const codigosValidos = ["A2604", "CERI-SLIM-CABALLERO", "ESTICK-NEG-OPT", "FIT-OPT-SLIM", "PLAST2\"", "45X45XC110", "CINTRANS48X150", "CINTRASIV"];
            function toggleView(showCard) {
                document.getElementById("tarjetaProductos").style.display = showCard ? "block" : "none";
                document.getElementById("infoTitle").style.display = showCard ? "block" : "none";
                document.getElementById("title").style.display = showCard ? "none" : "block";
                document.getElementById("reader").style.display = showCard ? "none" : "block";
                document.querySelector(".custom-file-upload").style.visibility = "hidden";
                document.getElementById("fileInput").style.display = "none";
                document.getElementById("startButton").style.display = showCard ? "none" : "block";
                document.getElementById("backButton").style.display = showCard ? "block" : "none";
            }
            document.getElementById("fileInput").addEventListener("change", function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet);
                };
                reader.readAsArrayBuffer(file);
            });
                   function mensaje(message, options = {}) {
    const alertBox = document.getElementById("customAlert");
    const alertMessage = document.getElementById("alertMessage");
    const closeButton = document.getElementById("closeAlertButton");

    // Configurar mensaje
    alertMessage.innerText = message;

    // Aplicar estilos personalizados
    if (options.backgroundColor) {
        alertBox.style.backgroundColor = options.backgroundColor;
    }
    if (options.textColor) {
        alertMessage.style.color = options.textColor;
    }

    // Mostrar el contenedor
    alertBox.style.display = "block";

    // Cerrar el mensaje al hacer clic en el botón
    closeButton.onclick = () => {
        alertBox.style.display = "none";
    };
}  
            function playScanSound() {
    const audio = new Audio("https://github.com/KAMPOS31/kampos31.github.io/raw/refs/heads/main/beep.mp3"); // URL del archivo en línea
    audio.play().catch(err => {
        console.warn("El sonido no pudo reproducirse automáticamente:", err);
    });
}
            function searchProduct(qrCode) {
                   if (codigo == "OSLIMCAB") {
                        const productosFiltrados = excelData.filter(prod => codigosValidos.includes(prod["Código"]));
                mostrarTarjetaProductos(productosFiltrados);
        });
        return;
                 mensaje("Código no válido. Escanea el código correcto.", {
            backgroundColor: "#f8d7da",
            textColor: "#721c24"
    }
               
            }
            function mostrarTarjetaProductos(productos) {
                const contenedor = document.getElementById("tarjetaProductos");
                contenedor.innerHTML = "";
                productos.forEach(prod => {
                    contenedor.innerHTML += `
                        <div class='tarjeta'>
                            <p><strong>Descripción:</strong> ${prod["Descripción"]}</p>
                            <p><strong>Proveedor:</strong> ${prod["Proveedor"]}</p>
                            <label>Cantidad:</label>
                            <input type='number' min='0' id='cantidad_${prod["Código"]}' value='0'>
                        </div>
                    `;
                });
                contenedor.innerHTML += `
                    <button id='generarVale' onclick='confirmarGenerarVale()'>Generar Vale</button>
                    <button id='cancelar' onclick='location.reload()'>Cancelar</button>
                `;
                toggleView(true);
            }
            function confirmarGenerarVale() {
                if (confirm("¿Los datos ingresados son correctos?")) {
                    generarVale();
                }
            }
            function generarVale() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const imgUrl = "https://github.com/KAMPOS31/kampos31.github.io/raw/refs/heads/main/Imagen1.jpg";
                doc.addImage(imgUrl, "JPEG", 10, 10, 50, 50);
                doc.setFontSize(16);
                doc.text("VALE DE ALMACÉN", 70, 20);
                doc.setFontSize(12);
                doc.text("HABILITACIÓN", 80, 28);
                doc.text("FOLIO: 7545", 160, 20);
                let y = 50;
                doc.text("Sección: ____________", 10, y);
                doc.text("Fecha: ____/____/____", 130, y);
                y += 10;
                doc.autoTable({
                    head: [["Descripción", "Proveedor", "Cantidad"]],
                    body: obtenerDatosProductos(),
                    startY: y
                });
                y = doc.autoTable.previous.finalY + 20;
                doc.text("ENTREGÓ: __________________", 10, y);
                doc.text("RECIBIÓ: __________________", 130, y);
                doc.save("vale_almacen.pdf");
                // Incrementar el folio y guardarlo en localStorage
                    folio++;
                    localStorage.setItem("folio", folio);
            }
            function obtenerDatosProductos() {
                return Array.from(document.querySelectorAll(".tarjeta")).map(tarjeta => {
                    const descripcion = tarjeta.querySelector("p").innerText.split(": ")[1];
                    const proveedor = tarjeta.querySelectorAll("p")[1].innerText.split(": ")[1];
                    const cantidad = tarjeta.querySelector("input").value;
                    return [descripcion, proveedor, cantidad];
                });
            }
            document.getElementById("startButton").addEventListener("click", function() {
                if (excelData.length === 0) {
                    mensaje("Por favor, carga un archivo Excel antes de iniciar el escaneo.");
                    return;
                }
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, qrCodeMessage => {
                     playScanSound();
                    searchProduct(qrCodeMessage);
                    html5QrCode.stop();
                });
            });
        });
    </script>
</body>
</html>
